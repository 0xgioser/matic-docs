---
id: protocol
title: Протокол Nightfall
sidebar_label: Nightfall Protocol
description: "Процесс Nightfall."
keywords:
  - docs
  - polygon
  - nightfall
  - protocol
  - chain
  - block
  - structure
  - layer
image: https://matic.network/banners/matic-network-16x9.png
---

Мы исходим из того, что по меньшей мере один автор предложения зарегистрировался в системе, разместив минимальный стейк.

## Размещение транзакции {#transaction-posting}
Существуют два механизма для размещения новых транзакций:

- [В цепочке](#on-chain)
- [Безблокчейновый](#off-chain)

### В цепочке {#on-chain}
Процесс начинается с того, что участник транзакции создает транзакцию, вызвав `submitTransaction` на `Shield.sol`. Участник транзакции выплачивает комиссию контракту Shield за транзакцию, размер которой может быть любым по усмотрению участника транзакции. Она будет выплачена автору предложения, который включит транзакцию в блок. В настоящее время автор предложения и базовый экземпляр Optimist, вероятно, выберут более высокие комиссии для включения в блок, точно так же, как поступил бы майнер.
Вызов транзакции влечет за собой размещение события блокчейна, содержащего ее детали. Если это депозит, контракт Shield принимает оплату соответствующего токена ERC первого уровня.

### Безблокчейновый {#off-chain}
Транзакции трансфера и вывода предусматривают возможность отправки непосредственно прослушивающим авторам предложений вместо отправки в цепочку посредством вышеуказанного процесса.
Эти безблокчейновые транзакции сэкономят участникам транзакций стоимость депозита за отправку в цепочку (примерно 45 000 газа), но они требуют большого доверия между участниками транзакций и авторами предложений, к которым они предпочтут подключиться. Злонамеренным авторам предложений легче цензурировать транзакции, полученные вне цепочки, чем полученные в цепочке, поскольку эти транзакции не транслируются всем прослушивающим авторами предложений. В этом случае участники транзакций считают транзакцию заслуживающей доверия только по истечении периода обдумывания (одна неделя).

## Акцепт транзакции {#transaction-acceptance}
Когда авторы предложений получают любые транзакции, они проводят ряд проверок для подтверждения того, что транзакция хорошо сформирована и что доказательство согласуется с публичным входным хэшем.
В случае успешного прохождения всех проверок транзакция добавляется в пул памяти автора предложения, чтобы считаться включенной в блок.

## Сборка и отправка блока {#block-assembly-and-submission}
Авторы предложений ждут, пока контракт Shield не назначит их в качестве текущего автора предложения.
Текущий автор предложения получает от собственного внутреннего экземпляра Optimist новый блок, содержащий транзакции из его пула памяти. Для каждой транзакции он будет вычислять дерево Меркла нового обязательства, которое возникнет, если эти транзакции должны быть добавлены в контракт Shield.

Таким образом, блок содержит хэши транзакций, включенных в блок, а также корень дерева Меркла обязательства в том виде, в каком он бы существовал после обработки всех транзакций в блоке (корень обязательства). Затем автор предложения отправляет этот блок в смарт-контракт состояния.

Когда предлагается блок, в цепочку записывается следующая информация:

- Структура данных блока
```
  struct Block {
    uint48 leafCount; // note this is defined to be the number of leaves BEFORE the commitments in this block are added
    address proposer;
    bytes32 root; // the 'output' commitment root after adding all commitments
    uint256 blockNumberL2;
    bytes32 previousBlockHash;
    bytes32 transactionHashesRoot;
  }
```
- Транзакции в блоке
```
    struct Transaction {
        uint112 value;
        uint112 fee;
        TransactionTypes transactionType;
        TokenType tokenType;
        uint64[2] historicRootBlockNumberL2; // number of L2 block containing historic root
        uint64[2] historicRootBlockNumberL2Fee; //number of L2 block containing historic root fee
        bytes32 tokenId;
        bytes32 ercAddress;
        bytes32 recipientAddress;
        bytes32[2] commitments;
        bytes32[2] nullifiers;
        bytes32[1] commitmentFee;
        bytes32[2] nullifiersFee;
        bytes32[2] compressedSecrets;
        uint256[4] proof;
    }
```

## Вызовы {#challenges}
Блоки будут оспариваться в очереди в течение недели. В этот период их правильность может быть оспорена посредством вызова одной из следующих функций. Вызовы, которые могут быть предъявлены:

- **INVALID_PROOF** — достоверность доказательства, приведенного в транзакции, не подтверждается;
- **INVALID_PUBLIC_INPUT_HASH** — хэш публичного ввода транзакции не является правильным хэшем публичных вводов;
- **HISTORIC_ROOT_EXISTS** — корень дерева Меркла обязательства, используемый для создания доказательства транзакции, никогда не существовал;
- **DUPLICATE_NULLIFIER** — обнулитель, указанный как часть транзакции, присутствует в списке потраченных обнулителей;
- **HISTORIC_ROOT_INVALID** — обновленный корень обязательства, возникающий в результате обработки транзакций в блоки, является неверным;
- **DUPLICATE_TRANSACTION** — транзакция, идентичная включенной в этот блок, уже была включена в предыдущий блок;
- **TRANSACTION_TYPE_INVALID** — транзакция плохо сформирована, исходя из типа транзакции (например, депозит, трансфер, вывод).

Если вызов будет успешным, т. е. вычисление в цепочке покажет его действительность, то принимаются следующие меры:

- Хэш соответствующего блока и все последующие блоки удаляются из очереди.
- Стейк блока, отправленный автором предложения, выплачивается оспаривающему узлу.
- Участникам транзакций с транзакцией в блоке возмещается комиссия, которую они выплатили бы автору предложения, и любые условно депонированные средства, удерживаемые контрактом Shield в случае транзакции депозита.


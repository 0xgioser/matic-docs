---
id: protocol
title: Nightfall Protocol
sidebar_label: Nightfall Protocol
description: "กระบวนการ Nightfall"
keywords:
  - docs
  - polygon
  - nightfall
  - protocol
  - chain
  - block
  - structure
  - layer
image: https://matic.network/banners/matic-network-16x9.png
---


เราคิดว่ามีผู้เสนออย่างน้อย 1 รายลงทะเบียนกับระบบ โดยโพสต์สอตคขั้นต่ำ

## การโพสต์รายการธุรกรรม {#transaction-posting}
มีสองกลไกในการโพสต์ธุรกรรมใหม่:

- [แบบ On-chain](#on-chain)
- [แบบ Off-chain](#off-chain)

### แบบ On-chain {#on-chain}
กระบวนการเริ่มต้นด้วยผู้ทำธุรกรรมที่สร้างธุรกรรมโดยการเรียก`submitTransaction`และ`Shield.sol`ผู้ทำธุรกรรมจ่ายค่าธรรมเนียมให้กับสัญญาชิลด์สำหรับธุรกรรม ซึ่งสามารถเป็นอะไรก็ได้ที่ผู้ทำธุรกรรมตัดสินใจซึ่งจะจ่ายให้กับผู้เสนอที่รวมธุรกรรมไว้ในบล็อกปัจจุบัน ผู้เสนอและอินสแตนซ์ Optimist พื้นฐานมักจะเลือกค่าธรรมเนียมที่สูงขึ้นเพื่อรวมในบล็อก เหมือนกับที่นักขุดจะทำการเรียกธุรกรรมทำให้มีการโพสต์เหตุการณ์บล็อคเชนโดยมีรายละเอียดหากเป็นการฝากเงิน สัญญาชิลด์จะชำระเงินของโทเค็น Layer 1 ERC ที่เป็นปัญหา

### แบบ Off-chain {#off-chain}
ธุรกรรมการโอนและถอนมีตัวเลือกในการส่งโดยตรงไปยังผู้เสนอที่รับฟังมากกว่าส่งแบบ on-chain ผ่านกระบวนการข้างต้นธุรกรรมแบบ off-chain เหล่านี้จะช่วยประหยัดทรานส์แอคเตอร์ในค่าใช้จ่ายในการฝากเงิน (~45k gas) แต่พวกเขาต้องการระดับความเชื่อถือที่มากขึ้นระหว่างผู้ทำธุรกรรมและผู้เสนอที่พวกเขาเลือกที่จะเชื่อมต่อผู้เสนอที่ประพฤติตัวไม่ดีจะเซ็นเซอร์ธุรกรรมที่ได้รับแบบ off-chain ได้ง่ายกว่าที่ได้รับแบบ on-chain เนื่องจากธุรกรรมเหล่านี้ไม่ได้ออกอากาศไปยังผู้เสนอที่รับฟังทั้งหมดในกรณีนี้ ผู้ทำธุรกรรมควรพิจารณาธุรกรรมที่ไว้วางใจได้ก็ต่อเมื่อพ้นระยะปลอดพันธะ (1 สัปดาห์) เท่านั้น

## การยอมรับธุรกรรม {#transaction-acceptance}
เมื่อผู้เสนอซื้อได้รับธุรกรรมใด ๆ พวกเขาดำเนินการตรวจสอบช่วงหนึ่งเพื่อตรวจสอบว่าธุรกรรมนั้นมีรูปแบบที่ดีและหลักฐานยืนยันกับแฮชอินพุตสาธารณะหากผ่านการตรวจสอบทั้งหมด ธุรกรรมจะถูกเพิ่มไปยังเมมพูล (mempool) ของผู้เสนอเพื่อพิจารณาในบล็อก

## การประกอบและการส่งบล็อก {#block-assembly-and-submission}
ผู้เสนอราคารอจนกว่าสัญญาชิลด์จะมอบหมายให้เป็นผู้เสนอปัจจุบันผู้เสนอปัจจุบันได้รับบล็อกใหม่ที่มีธุรกรรมจากเมมพูล (mempool) จากอินสแตนซ์ Optimist ภายในของตัวเองสำหรับแต่ละธุรกรรม จะคำนวณข้อผูกมัดใหม่ Merkle Tree ที่จะเกิดขึ้นหากมีการเพิ่มธุรกรรมเหล่านี้ในสัญญาชิลด์

ดังนั้น บล็อคจึงประกอบด้วยแฮชของธุรกรรมที่รวมอยู่ในบล็อคและรูทข้อผูกมัด Merkle Tree ตามที่จะมีอยู่หลังจากประมวลผลธุรกรรมทั้งหมดในบล็อค (รูทข้อผูกมัด)จากนั้น ผู้เสนอจะส่งบล็อกนี้ไปยังสัญญาอัจฉริยะสถานะ

เมื่อมีการเสนอบล็อก ข้อมูลต่อไปนี้จะถูกบันทึกแบบ on-chain:

- โครงสร้างข้อมูล บล็อก
```
  struct Block {
    uint48 leafCount; // note this is defined to be the number of leaves BEFORE the commitments in this block are added
    address proposer;
    bytes32 root; // the 'output' commitment root after adding all commitments
    uint256 blockNumberL2;
    bytes32 previousBlockHash;
    bytes32 transactionHashesRoot;
  }
```
- ธุรกรรมในบล็อก
```
    struct Transaction {
        uint112 value;
        uint112 fee;
        TransactionTypes transactionType;
        TokenType tokenType;
        uint64[2] historicRootBlockNumberL2; // number of L2 block containing historic root
        uint64[2] historicRootBlockNumberL2Fee; //number of L2 block containing historic root fee
        bytes32 tokenId;
        bytes32 ercAddress;
        bytes32 recipientAddress;
        bytes32[2] commitments;
        bytes32[2] nullifiers;
        bytes32[1] commitmentFee;
        bytes32[2] nullifiersFee;
        bytes32[2] compressedSecrets;
        uint256[4] proof;
    }
```

## ความท้าทาย {#challenges}
บล็อกจะท้าทายได้ในคิวเป็นเวลาหนึ่งสัปดาห์ ในช่วงเวลานั้น ความถูกต้องอาจถูกท้าทายโดยการเรียกหนึ่งในหน้าที่ที่ท้าทายความท้าทายที่สามารถทำได้คือ:

- **INVALID_PROOF** - หลักฐานที่ระบุในธุรกรรมไม่ยืนยันว่าเป็นจริง
- **INVALID_PUBLIC_INPUT_HASH** - แฮชอินพุตสาธารณะของธุรกรรมไม่ใช่แฮชที่ถูกต้องของอินพุตสาธารณะ
- **HISTORIC_ROOT_EXISTS** - รากฐานของข้อผูกมัดที่ Merkle Tree ใช้ในการสร้างหลักฐานการทำธุรกรรมไม่เคยมีอยู่จริง
- **DUPLICATE_NULLIFIER** - การทำให้เป็นโมฆะที่กำหนดเป็นส่วนหนึ่งของธุรกรรม มีอยู่ในรายการของการทำให้เป็นโมฆะที่ใช้ไป
- **HISTORIC_ROOT_INVALID** - รูทข้อผูกมัดที่อัปเดตซึ่งเป็นผลมาจากการประมวลผลธุรกรรมในบล็อกนั้นไม่ถูกต้อง
- **DUPLICATE_TRANSACTION** - ธุรกรรมที่เหมือนกันที่รวมอยู่ในบล็อกนี้ได้ถูกรวมไว้ในบล็อกก่อนหน้าแล้ว
- **TRANSACTION_TYPE_INVALID** - ธุรกรรมมีรูปแบบไม่ดีตามประเภทธุรกรรม (เช่น ฝาก โอน ถอน)

หากการท้าทายสำเร็จ เช่น การคำนวณแบบ on-chain แสดงว่าเป็นการท้าทายที่ถูกต้อง ให้ดำเนินการดังต่อไปนี้:

- แฮชของบล็อกที่เป็นปัญหาและบล็อกที่ตามมาทั้งหมดจะถูกลบออกจากคิว
- บล็อคสเตคที่ส่งโดยผู้เสนอจะจ่ายให้กับ Challenger
- ผู้ทำธุรกรรมที่มีธุรกรรมในบล็อกจะได้รับเงินคืนด้วยค่าธรรมเนียมที่พวกเขาจะจ่ายให้กับผู้เสนอและกองทุนที่ถือครองโดยสัญญาชิลด์ ในกรณีของธุรกรรมการฝากเงิน

